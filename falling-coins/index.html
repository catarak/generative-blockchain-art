<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Cryptocurrency Art</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/three.js/r75/three.min.js"></script>
	<script src="scripts/STLLoader.js"></script>
	<script src="scripts/OrbitControls.js"></script>
	<style>
		html, body {
      overflow: hidden;
      margin: 0;
      padding: 0;
      background:white;
    }
	</style>
</head>
<body>
	<script>
		//socket io stuff
		var eventToListenTo = 'tx';
		var room = 'inv';
		var socket = io("https://blockexplorer.com/");
		socket.on('connect', function() {
		  // Join the room.
		  socket.emit('subscribe', room);
		});

		var renderer;
		var scene;
		var camera;
		var cameraTarget;
		var cameraControl;
		var NUM_COINS = 0;
		var coins = new Array(NUM_COINS);
		var coinGeometry;
		var coinMaterial;

		function init() {
			scene = new THREE.Scene();

			camera = new THREE.PerspectiveCamera( 35, window.innerWidth / window.innerHeight, 1, 15 );
			camera.position.set( 0, 0.15, 3 );
			cameraTarget = new THREE.Vector3( 0, 0, 0 );
			camera.lookAt(cameraTarget);

			cameraControl = new THREE.OrbitControls(camera);

			renderer = new THREE.WebGLRenderer();
      renderer.setClearColor(0x000000, 1.0);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMapEnabled = true;
			
			//it's GOLD
			coinMaterial = new THREE.MeshPhongMaterial( { color: 0xaa9944, specular:0xbbaa99, shininess:50, combine: THREE.MultiplyOperation } );
      var loader = new THREE.STLLoader();
      loader.load('./assets/B.stl', function(geometry) {
      	coinGeometry = geometry;
      	for (var i = 0; i < coins.length; i++) {
      		coins[i] = new THREE.Mesh(geometry, coinMaterial);
      		var x = Math.random()*4 - 2.0;
      		var y = Math.random()*6.2 - 1.2;
      		var z = Math.random()*5 - 4;
					coins[i].position.set( x, y, z );
					coins[i].rotation.set(Math.random()*2*Math.PI, Math.random()*2*Math.PI, Math.random()*2*Math.PI);
					coins[i].scale.set( 0.005, 0.005, 0.005 );
					coins[i].castShadow = true;
					coins[i].receiveShadow = true;
					coins[i].rotationalVelocity = new THREE.Vector3(Math.random()*0.03,Math.random()*0.03,Math.random()*0.03);
					scene.add( coins[i] );
      	}
      });

      scene.add( new THREE.HemisphereLight( 0x443333, 0x111122 ) );
      addShadowedLight( 1, 1, 1, 0xffffff, 1.0 );
			addShadowedLight( 0.5, 1, -1, 0xffaa00, 1 );
			// addShadowedLight( 0.5, 1, -1, 0xffffff, 1 );

			// var axisHelper = new THREE.AxisHelper( 5 );
			// scene.add( axisHelper );

      document.body.appendChild(renderer.domElement);
      render();
		}

		function render() {
			requestAnimationFrame(render);
			renderer.render(scene, camera);
			cameraControl.update();	
			for (var i = 0; i < coins.length; i++) {
				coins[i].position.y -= 0.004;
				coins[i].rotation.x += coins[i].rotationalVelocity.x;
				coins[i].rotation.y += coins[i].rotationalVelocity.y;
				coins[i].rotation.z += coins[i].rotationalVelocity.z;
				if (coins[i].position.y < -3) {
					coins[i].position.y = 3;
				}
			}
		}

		function addShadowedLight( x, y, z, color, intensity ) {
				var directionalLight = new THREE.DirectionalLight( color, intensity );
				directionalLight.position.set( x, y, z );
				scene.add( directionalLight );
				directionalLight.castShadow = true;
				// directionalLight.shadowCameraVisible = true;
				var d = 1;
				directionalLight.shadowCameraLeft = -d;
				directionalLight.shadowCameraRight = d;
				directionalLight.shadowCameraTop = d;
				directionalLight.shadowCameraBottom = -d;
				directionalLight.shadowCameraNear = 1;
				directionalLight.shadowCameraFar = 4;
				directionalLight.shadowMapWidth = 1024;
				directionalLight.shadowMapHeight = 1024;
				directionalLight.shadowBias = -0.005;
			}

    function handleResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }
    window.onload = init;
    window.addEventListener('resize', handleResize, false);

    socket.on(eventToListenTo, function(data) {
		  console.log("New transaction received: " + data.txid);
		  //add another coin
		  var newCoin = new THREE.Mesh(coinGeometry, coinMaterial);
		  var x = Math.random()*4 - 2.0;
  		var y = Math.random()*6.2 - 1.2;
  		var z = Math.random()*5 - 4;
			newCoin.position.set( x, y, z );
			newCoin.rotation.set(Math.random()*2*Math.PI, Math.random()*2*Math.PI, Math.random()*2*Math.PI);
			newCoin.scale.set( 0.005, 0.005, 0.005 );
			newCoin.castShadow = true;
			newCoin.receiveShadow = true;
			newCoin.rotationalVelocity = new THREE.Vector3(Math.random()*0.03,Math.random()*0.03,Math.random()*0.03);
			scene.add( newCoin );
			coins.push(newCoin);
		});
	</script>
</body>
</html>
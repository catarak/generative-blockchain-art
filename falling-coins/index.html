<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Cryptocurrency Art</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/three.js/r75/three.min.js"></script>
	<script src="scripts/STLLoader.js"></script>
	<script src="scripts/OBJLoader.js"></script>
	<script src="scripts/OrbitControls.js"></script>
	<script src="scripts/cannon.min.js"></script>
	<style>
		html, body {
      overflow: hidden;
      margin: 0;
      padding: 0;
      background:white;
    }
	</style>
</head>
<body>
	<script>
		//socket io stuff
		var eventToListenTo = 'tx';
		var room = 'inv';
		var socket = io("https://blockexplorer.com/");
		socket.on('connect', function() {
		  // Join the room.
		  socket.emit('subscribe', room);
		});

		var renderer;
		var scene;
		var camera;
		var cameraTarget;
		var cameraControl;
		var NUM_COINS = 0;
		var coins = new Array(NUM_COINS);
		var coinMaterial;
		var coinMesh;

		//cannonjs stuff
		var world;
		var physicsCoins = new Array(NUM_COINS);

		var time = new Date().getTime();
		var dt;

		//cylinder collider testing stuff
		var cylinders = new Array(NUM_COINS);
		var cylinderGeometry = new THREE.CylinderGeometry( 0.20, 0.20, 0.07, 64 );
		var cylinderMaterial = new THREE.MeshBasicMaterial( {color: 0xffff00} );
		var cylinderMesh = new THREE.Mesh(cylinderGeometry, cylinderMaterial);

		function init() {
      initThree();
     	initCannon();
      render();
		}

		function initThree() {
						scene = new THREE.Scene();

			camera = new THREE.PerspectiveCamera( 35, window.innerWidth / window.innerHeight, 1, 15 );
			camera.position.set( 0, 0.15, 3 );
			cameraTarget = new THREE.Vector3( 0, 0, 0 );
			camera.lookAt(cameraTarget);

			cameraControl = new THREE.OrbitControls(camera);

			renderer = new THREE.WebGLRenderer({antialias: true});
      renderer.setClearColor(0x000000, 1.0);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMapEnabled = true;
			
			//it's GOLD
			coinMaterial = new THREE.MeshPhongMaterial( { color: 0xaa9944, specular:0xbbaa99, shininess:50, combine: THREE.MultiplyOperation } );
			var silverMaterial = new THREE.MeshPhongMaterial( { color: 0xffffff, specular: 0xffffff, shininess:50, combine: THREE.MultiplyOperation } );
      // var loader = new THREE.STLLoader();
      var loader = new THREE.OBJLoader();
      loader.load('./assets/NewCoin-5.obj', function(object) {
      	coinMesh = object.children[0];
      	coinMesh.material.setValues({ color: 0xffffff, specular:0xffffff, shininess: 50, combine: THREE.MultiplyOperation });
      	for (var i = 0; i < coins.length; i++) {
      		coins[i] = coinMesh.clone();
      		var x = Math.random()*4 - 2.0;
      		var y = Math.random()*6.2 - 1.2;
      		var z = Math.random()*5 - 4;
					// coins[i].position.set( x, y, z );
					coins[i].rotation.set(Math.random()*2*Math.PI, Math.random()*2*Math.PI, Math.random()*2*Math.PI);
					//coins[i].scale.set( 0.3, 0.3, 0.3 );
					coins[i].castShadow = true;
					coins[i].receiveShadow = true;
					coins[i].rotationalVelocity = new THREE.Vector3(Math.random()*0.03,Math.random()*0.03,Math.random()*0.03);
					scene.add( coins[i] );
      	}
      });

      scene.add( new THREE.HemisphereLight( 0x443333, 0x111122 ) );
      addShadowedLight( 1, 1, 1, 0xffffff, 1.0 );
			// addShadowedLight( 0.5, 1, -1, 0xffaa00, 1 );
			addShadowedLight( 0.5, 1, -1, 0xffffff, 1 );

			// var axisHelper = new THREE.AxisHelper( 5 );
			// scene.add( axisHelper );

      document.body.appendChild(renderer.domElement);
		}

		function initCannon() {
			world = new CANNON.World();
			// world.gravity.set(0, -9.82, 0);
			world.gravity.set(0, -0.05, 0);
			world.broadphase = new CANNON.NaiveBroadphase();
			world.solver.iterations = 10;

			for (var i = 0; i < physicsCoins.length; i++) {
				// var shape = new CANNON.Cylinder(0.649, 0.649, 0.157, 100);
				var shape = new CANNON.Cylinder(0.1947, 0.1947, 0.0471, 100);
				var mass = 1;
				var x = Math.random()*4 - 2.0;
    		// var y = Math.random()*6.2 - 1.2;
    		var y = 3;
    		var z = Math.random()*5 - 4;
				physicsCoins[i] = new CANNON.Body({
					mass: 1,
					position: new CANNON.Vec3(x,y,z)
				});
				physicsCoins[i].addShape(shape);
				world.addBody(physicsCoins[i]);
			}
		}

		function render() {
			requestAnimationFrame(render);
			var now = new Date().getTime();
			dt = (now - time)/1000;
			time = now;

			renderer.render(scene, camera);
			cameraControl.update();	
			updatePhysics();
		}

		//fake physics
		function updateCoins() {
			for (var i = 0; i < coins.length; i++) {
				coins[i].position.y -= 0.004;
				coins[i].rotation.x += coins[i].rotationalVelocity.x;
				coins[i].rotation.y += coins[i].rotationalVelocity.y;
				coins[i].rotation.z += coins[i].rotationalVelocity.z;
				//this prevents the coins from falling forever
				// if (coins[i].position.y < -3) {
				// 	coins[i].position.y = 3;
				// }
			}
		}

		function updatePhysics() {
			world.step(dt);

			for (var i = 0; i < coins.length; i++) {
				if (physicsCoins[i]) {
					coins[i].position.copy(physicsCoins[i].position);
					coins[i].quaternion.copy(physicsCoins[i].quaternion);

					// cylinders[i].position.copy(physicsCoins[i].position);
					// cylinders[i].quaternion.copy(physicsCoins[i].quaternion);
				}
			}
		}

		function addShadowedLight( x, y, z, color, intensity ) {
				var directionalLight = new THREE.DirectionalLight( color, intensity );
				directionalLight.position.set( x, y, z );
				scene.add( directionalLight );
				directionalLight.castShadow = true;
				// directionalLight.shadowCameraVisible = true;
				var d = 1;
				directionalLight.shadowCameraLeft = -d;
				directionalLight.shadowCameraRight = d;
				directionalLight.shadowCameraTop = d;
				directionalLight.shadowCameraBottom = -d;
				directionalLight.shadowCameraNear = 1;
				directionalLight.shadowCameraFar = 4;
				directionalLight.shadowMapWidth = 1024;
				directionalLight.shadowMapHeight = 1024;
				directionalLight.shadowBias = -0.005;
			}

    function handleResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }
    window.onload = init;
    window.addEventListener('resize', handleResize, false);

    socket.on(eventToListenTo, function(data) {
		  console.log("New transaction received: " + data.txid);
		  //add another coin
		  var newCoin = coinMesh.clone();
			newCoin.position.set( 0, 10, 0 );
			newCoin.scale.set( 0.3, 0.3, 0.3 );
			newCoin.castShadow = true;
			newCoin.receiveShadow = true;
			scene.add( newCoin );
			coins.push(newCoin);

			// var newCylinder = cylinderMesh.clone();
			// newCylinder.castShadow = true;
			// newCylinder.receiveShadow = true;
			// scene.add( newCylinder );
			// cylinders.push(newCylinder);

			
			// var shape = new CANNON.Cylinder(0.1947, 0.1947, 0.0471, 100);
			var shape = new CANNON.Cylinder(0.20, 0.20, 0.07, 64);
			var x = Math.random()*4 - 2.0;
  		// var y = Math.random()*6.2 - 1.2;
  		var y = 3;
  		var z = Math.random()*5 - 4;
			var body = new CANNON.Body({
				mass: 1,
				position: new CANNON.Vec3(x,y,z)
			});
			body.addShape(shape);
			body.angularVelocity.set(Math.random()*1,Math.random()*1,Math.random()*1);
			world.addBody(body);
			physicsCoins.push(body);
		});
	</script>
</body>
</html>